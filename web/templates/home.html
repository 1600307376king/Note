{% extends 'base/base.html' %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="/css/myself/home/home.css">

    <style>
        .searchBox {
            margin: 10px;
        }
        .searchBox input {
            margin-left: 10px;
        }
        .searchBox label {
            margin-left: 10px;
        }
        #submit {
            background: #FF8C69;
            border-radius: 5px;
            border: none;
            width: 60px;
            height: 30px;
            text-align: center;
            color: white;
        }
        #submit:hover {
            background: #EE3B3B
        }
        .line {
            width: 100%;
            height: 34px;
        }
        .redLine {
            margin-top: 15px;
            border: 3px solid #CD5C5C;
        }
        .labelInput {
            margin-bottom: 10px;
            background: white;
            color: white;
            min-width: 50px;
            width: 100%;
            {#border: none;#}
            border-radius: 5px;
            height: 34px;
            font-size: 16px;
            border: 1px solid #E8EAED;
        }
        .labelInput {
          transition: all 0.35s;
          transition-timing-function: cubic-bezier(0.31, -0.105, 0.43, 1.59);
        }
        .labelInput {
            -webkit-transform: scale(0.8);
            transform: scale(0.8);
            overflow: hidden;

            box-shadow: 0 5px 5px -5px rgba(0, 0, 0, 0.1);
            opacity: 0.99;
        }
        .labelInput:hover {
            color: white;
            -webkit-transform: scale(1);
            transform: scale(1);
        }
        .sort_note a {
            {#display: block;#}
            padding: 10px 20px;
            color: black;
            text-decoration: none;
        }


    </style>
{% endblock %}

{% block content %}
<div class="note_list">
    <div id="ri" class="ri">
        <div id="sort_note" class="sort_note">
            <ul>
                <li class="active filterCol">推荐</li>
                <li class="filterCol">最新添加</li>
{#                <li>最多点赞</li>#}
{#                <li>最多查看</li>#}
            </ul>
        </div>
        <ul class="notes">
            {% for r in res.get('note_msg') %}
            <li class="one_notes">
                <div class="list_detail">
                    <div class="note_title">
                        {% if r[1] | length <= 30 %}
                        <a style="font-size: 24px;font-weight: bold;" href="/detail/{{ r[0] }}/">{{ r[1] }}</a>
                        {% else %}
                        <a style="font-size: 24px;font-weight: bold;" href="/detail/{{ r[0] }}/">{{ r[1][:25] }} ...</a>
                        {% endif%}
                        <div class="edit_note">
                            <span><a href="{{ url }}/update/{{ r[0] }}/">修改</a></span>
                            <span class="v_line">|</span>
                            <span><a href="{{ url }}/delete/{{ r[0] }}/">删除</a></span>
                        </div>
                    </div>

                    <div class="note_content">
                        {{ r[2] }}
                    </div>
                    <div class="note_footer">
                        <div class="left_fo">
                            {% for i in r[3].split('|')[:-1] %}
                            <span>{{ i }}</span>
                            {% endfor %}
                        </div>
                        <div class="right_fo">
{#                            <span>#}
{#                                <img src="{{ url_for('static', filename='images/icon/good.png') }}" alt="">#}
{#                            </span>#}
{#                            <span class="num">18646</span>#}
{#                            <span class="v_line">#}
{#                                |#}
{#                            </span>#}
                            <span>
                                阅读数：
{#                                <img src="{{ url_for('static', filename='images/icon/read.png') }}" alt="">#}
                            </span>
                            <span class="num">{{ r[5] }}</span>
{#                            <span class="v_line">#}
{#                                |#}
{#                            </span>#}
{#                            <span>#}
{#                                <img src="{{ url_for('static', filename='images/icon/comment.png') }}" alt="">#}
{#                            </span>#}
{#                            <span class="num">48646</span>#}
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div id="le" class="le">
        <div id="searchBox" class="searchBox">
            <form method="post" enctype="multipart/form-data">
                {{ form.csrf_token() }}
                {{ form.keyword.label }}{{ form.keyword(size=10) }}
                {{ form.submit }}
                {% for message in get_flashed_messages() %}
                    {{ message }}
                {% endfor %}
            </form>
        </div>
        <div class="line">
            <div class="redLine"></div>
        </div>
        <div id="choiceLabel" class="choiceLabel">
            <div class="container" style="width: 100%">
                <form method="post">
                     <div class="row">
                    {% for z in res.get('note_labels')%}
                    <div class="col-xs-6">
                        <input type="submit" id="labelInput" class="labelInput" name="label_name" value="{{ z }}">
                    </div>
                    {% endfor %}
                </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>

    // 筛选
    $('.filterCol').on('click', function () {
        let filter = $(this);
        let filterName = filter[0].innerText;
        cloneScroll = 0;
        currentPage = 2;
        filterType = 1;
        is_append = 1;
        $.ajax({
            type: "POST",
            url: "/filter_col/",
            data: JSON.stringify({'filterName': filterName}),
            dataType: "json",
            headers: {
                'Content-Type': 'application/json',
            },
            success: function (response) {
                // 删除所有active 对当前添加active
                let filter_list = filter.parent("ul").children();
                for(let i = 0; i < filter_list.length; i++){
                    filter_list[i].classList.remove('active');
                }
                filter[0].classList.add("active");

                // 删除所有li 并重新添加li
                let liOneNotes = document.getElementsByClassName("one_notes");
                let notes = document.getElementsByClassName("notes")[0];
                let count = liOneNotes.length;
                let copyData = liOneNotes[0].cloneNode(true);

                for(let k = 0; k < count; k++){
                    notes.removeChild(liOneNotes[0]);
                }
                let responseData = response.note_msg;
                for(let j = 0; j < responseData.length; j ++){
                    let cloneData = copyData.cloneNode(true);
                    if(responseData[j][1].length > 50){
                        responseData[j][1] = responseData[j][1].substring(0, 50) + '...'
                    }
                    cloneData.childNodes[1].childNodes[1].childNodes[1].innerText = responseData[j][1];
                    if(responseData[j][2].length > 80){
                        responseData[j][2] = responseData[j][2].split('\n').join('');
                        responseData[j][2] = responseData[j][2].substring(0, 80)
                    }
                    cloneData.childNodes[1].childNodes[3].innerText = responseData[j][2];
                    let labelList = responseData[j][3].split('|');
                    for(let m = 0; m < labelList.length - 1; m++){
                        let index = (m + 1) * 2 - 1;
                        if(cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index] === undefined){
                            cloneData.childNodes[1].childNodes[5].childNodes[1].appendChild(document.createElement("span"));
                        }
                        cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index].innerText = labelList[m];
                    }

                    cloneData.childNodes[1].childNodes[5].childNodes[3].childNodes[3].innerText = responseData[j][5];
                    notes.append(cloneData);
                }
            }
        })
    });
    // 标签添加颜色
    let lb = document.getElementsByClassName("labelInput");

    let colorArray = ["#EEC591", "#EEAD0E", "#D8BFD8", "#A2CD5A", "#9BCD9B", "#7EC0EE"];
    let c = 0;
    for(let i=0; i<lb.length; i ++){
        if(c % 6 === 0){
            c = 0;
        }
        lb[i].style.color = colorArray[c];
        c += 1;
    }

    // 左侧下拉加载数据


    let cloneScroll = 0;
    // 当前页
    let currentPage = 2;
    // 筛选类型
    let filterType = 1;
    // 是否允许加载数据
    let is_append = 1;
    console.log($(document).height());

    window.onscroll = window.onresize = function(){
        // 滚动条移到顶部，左侧筛选框滑动效果
        let oScrollTop = $(window).scrollTop();
        if(cloneScroll > oScrollTop){
            {#console.log('向上');#}
            if(oScrollTop === 0){
                document.getElementById("le").style.position = "fixed";
                document.getElementById("le").style.top = "50px";
            }
        }
        if(cloneScroll < oScrollTop){
            {#console.log('向下');#}
            document.getElementById("le").style.position = "fixed";
            document.getElementById("le").style.top = "41px";
        }
        cloneScroll = oScrollTop;
        let totalHeight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());

        // 数据动态加载

        if($(document).height() <= totalHeight){

            if($(".sort_note ul .active")[0].innerText === '最新添加'){
                filterType = 3;
            }
            console.log(document.getElementsByClassName("notes")[0].childNodes.length);
            if(is_append !== -1){
                $.ajax({
                    type: "GET",
                    url: "/load_data/" + "?page=" + currentPage + "&type=" + filterType,
                    {#data: JSON.stringify({'page': currentPage}),#}
                    dataType: "json",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    success: function (response) {
                        {#console.log(response.res);#}
                        {#console.log(currentPage);#}
                        {#console.log(response.cur_num);#}
                        if(response.msg === 'continue') {
                            if(currentPage === parseInt(response.cur_num)){
                                is_append = -1
                            }
                            currentPage = response.cur_num;
                            let liOneNotes = document.getElementsByClassName("one_notes");
                            let notes = document.getElementsByClassName("notes")[0];
                            let copyData = liOneNotes[0].cloneNode(true);
                            let responseData = response.res;
                            for(let j = 0; j < responseData.length; j ++){
                                let cloneData = copyData.cloneNode(true);
                                if(responseData[j][1].length > 50){
                                    responseData[j][1] = responseData[j][1].substring(0, 50) + '...'
                                }
                                cloneData.childNodes[1].childNodes[1].childNodes[1].innerText = responseData[j][1];
                                if(responseData[j][2].length > 80){
                                    responseData[j][2] = responseData[j][2].split('\n').join('');
                                    responseData[j][2] = responseData[j][2].substring(0, 80)
                                }
                                cloneData.childNodes[1].childNodes[3].innerText = responseData[j][2];
                                let labelList = responseData[j][3].split('|');
                                for(let m = 0; m < labelList.length - 1; m++){
                                    let index = (m + 1) * 2 - 1;
                                    if(cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index] === undefined){
                                        cloneData.childNodes[1].childNodes[5].childNodes[1].appendChild(document.createElement("span"));
                                    }
                                    cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index].innerText = labelList[m];
                                }

                                cloneData.childNodes[1].childNodes[5].childNodes[3].childNodes[3].innerText = responseData[j][5];
                                notes.append(cloneData);
                            }

                        }else {
                            console.log('none')
                        }



                    }
                })
            }

        }
    }
</script>
{% endblock %}
