{% extends 'base/base.html' %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="/css/myself/home/home.css?v={{ getVersion }}">
    <style>
    .filterMenu {
        height: 700px;
        overflow-y: hidden;
        overflow-x: hidden;
        padding-right: 10px;
    }

    .filterMenu:hover {
        overflow-y: scroll;
        overflow-x: hidden;
        padding-right: 0;
    }

    .filterMenu::-webkit-scrollbar {/*滚动条整体样式*/
        width: 10px;     /*高宽分别对应横竖滚动条的尺寸*/
    }

    .filterMenu::-webkit-scrollbar-thumb {/*滚动条里面小方块*/
        border-radius: 10px;
        background: lightgray;
    }

    .filterMenu::-webkit-scrollbar-track {/*滚动条里面轨道*/
        border-radius: 10px;
        background: #EDEDED;
    }

    .levelOne {
        margin: 0;
        padding: 0;
    }

    .levelOne li {
        width: 70%;
        text-align: center;
        height: 40px;
        line-height: 40px;
        margin: 3px auto;
    }
    .levelOne li a {
        text-decoration: none;
        float: left;
        margin-left: 10px;
    }
    .levelOne li i {
        float: right;
        width: 30px;
        height: 100%;
    }
    .levelOne li i img {
        width: 10px;
        height: auto;
        margin-top: 15px;
    }
    .levelOne li img {
        float: left;
        height: 30px;
        width: 30px;
        margin-left: 10px;
        margin-right: 10px;
        margin-top: 5px;
    }

    .notes::-webkit-scrollbar {/*滚动条整体样式*/
        width: 10px;     /*高宽分别对应横竖滚动条的尺寸*/
    }

    .notes::-webkit-scrollbar-thumb {/*滚动条里面小方块*/
        border-radius: 10px;
        background: lightgray;
    }

    .notes::-webkit-scrollbar-track {/*滚动条里面轨道*/
        border-radius: 10px;
        background: #EDEDED;
    }


</style>
{% endblock %}

{% block content %}
<div class="note_list">
    <div id="ri" class="ri">
        <div id="sort_note" class="sort_note">
            <ul>
                <li class="active filterCol">推荐</li>
                <li class="filterCol">最新添加</li>
            </ul>
        </div>
        <ul class="notes" onscroll="roll()">
            {% for r in res.get('note_msg') %}
            <li class="one_notes">
                <div class="list_detail">
                    <div class="note_title">
                        {% if r[1] | length <= 30 %}
                        <a style="font-size: 24px;font-weight: bold;" href="/detail/{{ r[0] }}/">{{ r[1] }}</a>
                        {% else %}
                        <a style="font-size: 24px;font-weight: bold;" href="/detail/{{ r[0] }}/">{{ r[1][:25] }} ...</a>
                        {% endif%}
                        <div class="edit_note">
                            <span><a href="{{ url }}/update/{{ r[0] }}/">修改</a></span>
                            <span class="v_line">|</span>
                            <span><a href="{{ url }}/delete/{{ r[0] }}/">删除</a></span>
                        </div>
                    </div>

                    <div class="note_content">
                        {{ r[2] }}
                    </div>
                    <div class="note_footer">
                        <div class="left_fo">
                            {% for i in r[3].split('|')[:-1] %}
                            <span>{{ i }}</span>
                            {% endfor %}
                        </div>
                        <div class="right_fo">
                            <span>
                                阅读数：
                            </span>
                            <span class="num">{{ r[5] }}</span>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        <div id="loadTipBlock" class="loadTipBlock">
            正在加载请稍后...
        </div>
    </div>
    <div id="le" class="le">
        <div id="searchBox" class="searchBox">
            <form method="post" enctype="multipart/form-data">
                {{ form.csrf_token() }}
                {{ form.keyword.label }}{{ form.keyword(size=10) }}
                {{ form.submit }}
                {% for message in get_flashed_messages() %}
                    {{ message }}
                {% endfor %}
            </form>
        </div>
        <div class="line">
            <div class="redLine"></div>
        </div>
        <div id="choiceLabel" class="choiceLabel">
            <div class="filterMenu">
                <ul class="levelOne">
                    <li class="one">
                        <img src="/images/icon/python.png" alt="图片加载失败">
                        <a><h4>Python</h4></a>
                        <i><img src="/images/icon/level_one_triangle.png" alt="图片加载失败"></i>
                    </li>
                    <li class="one">
                        <img src="/images/icon/sql.png" alt="图片加载失败">
                        <a><h4>SQL</h4></a>
                        <i><img src="/images/icon/level_one_triangle.png" alt="图片加载失败"></i>
                    </li>
                    <li class="one">
                        <img src="/images/icon/linux.png" alt="图片加载失败">
                        <a><h4>Linux</h4></a>
                        <i><img src="/images/icon/level_one_triangle.png" alt="图片加载失败"></i>
                    </li>

                </ul>
            </div>
{#            <div class="container" style="width: 100%">#}
{#                <form method="post">#}
{#                     <div class="row">#}
{#                    {% for z in res.get('note_labels')%}#}
{#                    <div class="col-xs-6">#}
{#                        <input type="submit" id="labelInput" class="labelInput" name="label_name" value="{{ z }}">#}
{#                    </div>#}
{#                    {% endfor %}#}
{#                </div>#}
{#                </form>#}
{#            </div>#}
        </div>
    </div>
</div>
<script>
    //下拉菜单
    $('.one').on('click', function () {
        let fartherNode = $(this)[0].parentNode;
        let childrenMenu = document.createElement("li");
        childrenMenu.className = "one";
        childrenMenu.innerHTML = "<a><h4>Python</h4></a>";
        {#$(this)[0].insertBefore(childrenMenu);#}
        {#fartherNode.insert(childrenMenu);#}
        console.log(fartherNode);
        console.log($(this)[0]);
        console.log(childrenMenu);
        console.log($(this)[0].nextNode())
    });

    // 筛选
    $('.filterCol').on('click', function () {
        let filter = $(this);
        let filterName = filter[0].innerText;
        cloneScroll = 0;
        currentPage = 2;
        filterType = 1;
        is_append = 1;
        $.ajax({
            type: "POST",
            url: "/filter_col/",
            data: JSON.stringify({'filterName': filterName}),
            dataType: "json",
            headers: {
                'Content-Type': 'application/json',
            },
            success: function (response) {
                // 删除所有active 对当前添加active
                let filter_list = filter.parent("ul").children();
                for(let i = 0; i < filter_list.length; i++){
                    filter_list[i].classList.remove('active');
                }
                filter[0].classList.add("active");

                // 删除所有li 并重新添加li
                let liOneNotes = document.getElementsByClassName("one_notes");
                let notes = document.getElementsByClassName("notes")[0];
                let count = liOneNotes.length;
                let copyData = liOneNotes[0].cloneNode(true);

                for(let k = 0; k < count; k++){
                    notes.removeChild(liOneNotes[0]);
                }
                let responseData = response.note_msg;
                for(let j = 0; j < responseData.length; j ++){
                    let cloneData = copyData.cloneNode(true);
                    if(responseData[j][1].length > 50){
                        responseData[j][1] = responseData[j][1].substring(0, 50) + '...'
                    }
                    cloneData.childNodes[1].childNodes[1].childNodes[1].innerText = responseData[j][1];
                    if(responseData[j][2].length > 80){
                        responseData[j][2] = responseData[j][2].split('\n').join('');
                        responseData[j][2] = responseData[j][2].substring(0, 80)
                    }
                    cloneData.childNodes[1].childNodes[3].innerText = responseData[j][2];
                    let labelList = responseData[j][3].split('|');
                    for(let m = 0; m < labelList.length - 1; m++){
                        let index = (m + 1) * 2 - 1;
                        if(cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index] === undefined){
                            cloneData.childNodes[1].childNodes[5].childNodes[1].appendChild(document.createElement("span"));
                        }
                        cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index].innerText = labelList[m];
                    }

                    cloneData.childNodes[1].childNodes[5].childNodes[3].childNodes[3].innerText = responseData[j][5];
                    notes.append(cloneData);
                }
            }
        })
    });
    // 标签添加颜色
    let lb = document.getElementsByClassName("labelInput");

    let colorArrayRed = ["#FF6666"];
    let colorArrayYellow = ["#FF9966"];
    let colorArrayBlue = ["#0066CC"];
    let c = 0;
    for(let i=0; i<lb.length; i ++){
        if(c <= 6){
            lb[i].style.borderColor = colorArrayRed[0];
        }
        else if(12 <= c <= 18){
            lb[i].style.borderColor = colorArrayYellow[0];
        }
        else{
            lb[i].style.borderColor = colorArrayBlue[0];
        }
        c += 1;
    }

    // 左侧下拉加载数据


    let cloneScroll = 0;
    // 当前页
    let currentPage = 2;
    // 筛选类型
    let filterType = 1;
    // 是否允许加载数据
    let is_append = 1;
    let requestSwitch = 1;
    function roll(){
        let listObj = $(".notes");
        let domHeight = document.getElementsByClassName("notes")[0];
        // note列表数据动态加载
        if(domHeight.scrollHeight - 100 < listObj.scrollTop() + domHeight.clientHeight){

            if($(".sort_note ul .active")[0].innerText === '最新添加'){
                filterType = 3;
            }
            setTimeout(get_data,500);
        }
    }



    function get_data() {
        if(is_append !== -1 && requestSwitch === 1){
            requestSwitch = -1;
            document.getElementById("loadTipBlock").style.opacity = "100";
            $.ajax({
                type: "GET",
                url: "/load_data/" + "?page=" + currentPage + "&type=" + filterType,
                {#data: JSON.stringify({'page': currentPage}),#}
                dataType: "json",
                headers: {
                    'Content-Type': 'application/json',
                },
                success: function (response) {
                    if(response.msg === 'continue') {
                        if(response.warning === 'break' || currentPage === parseInt(response.cur_num)){
                            is_append = -1
                        }
                        currentPage = response.cur_num;

                        let liOneNotes = document.getElementsByClassName("one_notes");
                        let notes = document.getElementsByClassName("notes")[0];
                        let copyData = liOneNotes[0].cloneNode(true);
                        let responseData = response.res;
                        for(let j = 0; j < responseData.length; j ++){
                            let cloneData = copyData.cloneNode(true);
                            if(responseData[j][1].length > 50){
                                responseData[j][1] = responseData[j][1].substring(0, 50) + '...'
                            }
                            cloneData.childNodes[1].childNodes[1].childNodes[1].innerText = responseData[j][1];
                            if(responseData[j][2].length > 80){
                                responseData[j][2] = responseData[j][2].split('\n').join('');
                                responseData[j][2] = responseData[j][2].substring(0, 80)
                            }
                            cloneData.childNodes[1].childNodes[3].innerText = responseData[j][2];
                            let labelList = responseData[j][3].split('|');
                            for(let m = 0; m < labelList.length - 1; m++){
                                let index = (m + 1) * 2 - 1;
                                if(cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index] === undefined){
                                    cloneData.childNodes[1].childNodes[5].childNodes[1].appendChild(document.createElement("span"));
                                }
                                cloneData.childNodes[1].childNodes[5].childNodes[1].childNodes[index].innerText = labelList[m];
                            }

                            cloneData.childNodes[1].childNodes[5].childNodes[3].childNodes[3].innerText = responseData[j][5];
                            notes.appendChild(cloneData);
                        }
                        requestSwitch = 1;
                        document.getElementById("loadTipBlock").style.opacity = "0";
                    }

                }
            })
        }
    }


</script>
{% endblock %}
